pipeline {
    agent any

    stages {
        stage('checkout') {
            steps {
                script {
                    // Checkout your Terraform code
                    dir("terraform") {
                        git "https://github.com/pranavkumarpk01/Terraform-.git"
                    }
                }
            }
        }

        stage('Terraform Apply') {
            steps {
                script {
                    // Load Terraform secrets from the tfvars file
                    def tfvars = readTrusted('terraform/secrets.tfvars')

                    // Set up Terraform environment variables
                    withEnv([
                        "ARM_SUBSCRIPTION_ID=${tfvars.azure_subscription_id}",
                        "ARM_CLIENT_ID=${tfvars.azure_client_id}",
                        "ARM_CLIENT_SECRET=${tfvars.azure_client_secret}",
                        "ARM_TENANT_ID=${tfvars.azure_tenant_id}"
                    ]) {
                        // Run Terraform commands
                        sh 'cd terraform && terraform init && terraform plan -out=tfplan && terraform apply -auto-approve tfplan'
                    }
                }
            }
        }
    }
}
